name: CI/CD Pipeline - Train & Docker Build
# K3 - Workflow-CI | Author: Anwar-Rohmadi
# Trigger: Push ke main, manual dispatch

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/house-prices-model

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.19.0 scikit-learn pandas numpy dagshub joblib
      
      - name: Setup DagsHub MLflow tracking
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/Eksperimen_SML_Anwar-Rohmadi.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          echo "MLflow tracking configured"
      
      - name: Execute MLflow Project (mlflow run)
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/Eksperimen_SML_Anwar-Rohmadi.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
          MLFLOW_EXPERIMENT_NAME: Eksperimen_SML_Anwar-Rohmadi
        run: |
          mlflow run MLProject --env-manager=local -P max_iter=300 -P max_depth=10 -P learning_rate=0.1
      
      - name: Get Run ID
        id: get_run_id
        run: |
          RUN_ID=$(cat MLProject/model_output/run_id.txt)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: MLProject/model_output/
          retention-days: 30
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image with MLflow
        run: |
          mlflow models build-docker -m "runs:/${{ env.RUN_ID }}/model" -n ${{ env.DOCKER_IMAGE }} --enable-mlserver
      
      - name: Tag and Push Docker image
        run: |
          docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          echo "Docker image pushed: ${{ env.DOCKER_IMAGE }}:latest"
      
      - name: Update DockerHub link
        run: |
          echo "Tautan Docker Hub Kriteria 3 (Workflow-CI):" > MLProject/DockerHub.txt
          echo "https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/house-prices-model" >> MLProject/DockerHub.txt
          cat MLProject/DockerHub.txt

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add MLProject/DockerHub.txt
          git add MLProject/model_output/run_id.txt
          git commit -m "Update model artifacts and DockerHub link [skip ci]" || echo "No changes to commit"
          git push
